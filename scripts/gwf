#!/Users/mailund/anaconda/bin/python

import os
import sys
from gwf.parser import parse


import argparse

parser = argparse.ArgumentParser(description='Submit a workflow to the grid.')

parser.add_argument('-f', '--file', 
                    default='workflow.gwf', dest='workflow_file',
                    help='Workflow file if not the default (workflow.gwf).')
parser.add_argument('-d', '--dry-run', default=False, action='store_true',
                    help='The submit script will be printed but not executed.')
parser.add_argument('-c', '--clean', default=False, action='store_true',
                    help='Delete output files generated by a target.')
parser.add_argument('-l', '--local', default=False, action='store_true',
                    help='Run the scripts locally. Mostly useful for debugging'
                    ' your workflows.')

parser.add_argument('target', nargs=1,
                    help='The target to process.')

args = parser.parse_args()

workflow = parse(args.workflow_file)
target = args.target[0]
if target not in workflow.targets:
    print 'Target %s not found in workflow.' % target
    sys.exit(2)

if args.clean:
    if args.dry_run:
        print 'Cleaning', target, 'will delete the following files:'
        print workflow.targets[target].get_existing_outfiles()
        print
    else:
        workflow.targets[target].clean_target()
        
    sys.exit(0)

if args.local:
    script = workflow.get_local_execution_script(target)
    if args.dry_run:
        print 'When run, the following script will be executed:'
        print
        print script
        print

    else:
        print 'Running script'
        print script
        os.system(script)
        print 'Done'    

else:
    script = workflow.get_submission_script(target)
    if args.dry_run:
        print 'When run, the following script will be executed:'
        print
        print script
        print

    else:
        print 'Submitting jobs to queue...'
        os.system(script)
        print 'Done'